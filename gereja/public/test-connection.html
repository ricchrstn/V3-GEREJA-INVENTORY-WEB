<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="test-token-123">
    <title>Test Connection - HKBP Setia Mekar</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f8f9fa; }
        .container { max-width: 800px; margin: 0 auto; }
        .card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .btn { background: #007bff; color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; margin: 10px; font-size: 16px; }
        .btn:hover { background: #0056b3; }
        .btn.success { background: #28a745; }
        .btn.danger { background: #dc3545; }
        .status { padding: 15px; margin: 15px 0; border-radius: 8px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .log { background: #f8f9fa; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 12px; max-height: 400px; overflow-y: auto; white-space: pre-wrap; border: 1px solid #ddd; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .checklist { list-style: none; padding: 0; }
        .checklist li { padding: 8px 0; border-bottom: 1px solid #eee; }
        .checklist .check { color: #28a745; margin-right: 10px; }
        .checklist .cross { color: #dc3545; margin-right: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1><i class="fas fa-network-wired"></i> Test Connection - HKBP Setia Mekar</h1>
            <p>Diagnose masalah koneksi dan CRUD operations</p>
            
            <div class="status info" id="status">
                <i class="fas fa-info-circle"></i> Status: Ready to test...
            </div>
            
            <div class="grid">
                <div>
                    <h3><i class="fas fa-server"></i> Server Tests</h3>
                    <button class="btn" onclick="testBasicConnection()">
                        <i class="fas fa-plug"></i> Test Basic Connection
                    </button>
                    <button class="btn" onclick="testLaravelServer()">
                        <i class="fas fa-laravel"></i> Test Laravel Server
                    </button>
                    <button class="btn" onclick="testRoutes()">
                        <i class="fas fa-route"></i> Test Routes
                    </button>
                </div>
                
                <div>
                    <h3><i class="fas fa-cogs"></i> Component Tests</h3>
                    <button class="btn success" onclick="testComponents()">
                        <i class="fas fa-check-circle"></i> Check Components
                    </button>
                    <button class="btn danger" onclick="testCRUD()">
                        <i class="fas fa-database"></i> Test CRUD
                    </button>
                    <button class="btn" onclick="clearLog()">
                        <i class="fas fa-trash"></i> Clear Log
                    </button>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h3><i class="fas fa-list-check"></i> Component Checklist</h3>
            <ul class="checklist" id="checklist">
                <li id="csrf-check"><span class="cross"><i class="fas fa-times"></i></span>CSRF Token Meta</li>
                <li id="fontawesome-check"><span class="cross"><i class="fas fa-times"></i></span>Font Awesome</li>
                <li id="tailwind-check"><span class="cross"><i class="fas fa-times"></i></span>Tailwind CSS</li>
                <li id="server-check"><span class="cross"><i class="fas fa-times"></i></span>Laravel Server</li>
                <li id="routes-check"><span class="cross"><i class="fas fa-times"></i></span>Routes Available</li>
            </ul>
        </div>
        
        <div class="card">
            <h3><i class="fas fa-terminal"></i> Debug Log</h3>
            <div class="log" id="log">Waiting for tests...\n</div>
        </div>
    </div>

    <script>
    function log(message, type = 'info') {
        const logDiv = document.getElementById('log');
        const timestamp = new Date().toLocaleTimeString();
        const icons = {
            'info': '‚ÑπÔ∏è',
            'success': '‚úÖ',
            'error': '‚ùå',
            'warning': '‚ö†Ô∏è'
        };
        logDiv.innerHTML += `${icons[type]} [${timestamp}] ${message}\n`;
        logDiv.scrollTop = logDiv.scrollHeight;
    }

    function updateStatus(message, type = 'info') {
        const statusDiv = document.getElementById('status');
        const icons = {
            'info': 'fas fa-info-circle',
            'success': 'fas fa-check-circle',
            'error': 'fas fa-exclamation-circle',
            'warning': 'fas fa-exclamation-triangle'
        };
        statusDiv.innerHTML = `<i class="${icons[type]}"></i> ${message}`;
        statusDiv.className = `status ${type}`;
    }

    function updateChecklist(item, status) {
        const element = document.getElementById(item + '-check');
        if (element) {
            const span = element.querySelector('span');
            if (status) {
                span.className = 'check';
                span.innerHTML = '<i class="fas fa-check"></i>';
            } else {
                span.className = 'cross';
                span.innerHTML = '<i class="fas fa-times"></i>';
            }
        }
    }

    function clearLog() {
        document.getElementById('log').innerHTML = 'Log cleared...\n';
        updateStatus('Log cleared', 'info');
    }

    async function testBasicConnection() {
        updateStatus('Testing basic connection...', 'info');
        log('üîç Testing basic connection to current domain...', 'info');
        
        try {
            const response = await fetch(window.location.origin, {
                method: 'GET',
                headers: { 'Accept': 'text/html' }
            });
            
            if (response.ok) {
                log('‚úÖ Basic connection successful', 'success');
                updateChecklist('server', true);
                updateStatus('‚úÖ Server reachable', 'success');
                return true;
            } else {
                log(`‚ùå Server returned status: ${response.status}`, 'error');
                updateChecklist('server', false);
                updateStatus('‚ùå Server error', 'error');
                return false;
            }
        } catch (error) {
            log(`‚ùå Connection failed: ${error.message}`, 'error');
            updateChecklist('server', false);
            updateStatus('‚ùå Connection failed', 'error');
            return false;
        }
    }

    async function testLaravelServer() {
        updateStatus('Testing Laravel server...', 'info');
        log('üîç Testing Laravel specific endpoints...', 'info');
        
        const endpoints = [
            { url: '/', name: 'Root' },
            { url: '/login', name: 'Login Page' },
            { url: '/pengurus/dashboard', name: 'Pengurus Dashboard' }
        ];
        
        let laravelWorking = false;
        
        for (const endpoint of endpoints) {
            try {
                const response = await fetch(endpoint.url, {
                    method: 'GET',
                    headers: { 'Accept': 'text/html' }
                });
                
                if (response.ok) {
                    log(`‚úÖ ${endpoint.name} (${endpoint.url}) - OK`, 'success');
                    laravelWorking = true;
                } else if (response.status === 302) {
                    log(`üîÑ ${endpoint.name} (${endpoint.url}) - Redirect (normal)`, 'info');
                    laravelWorking = true;
                } else {
                    log(`‚ùå ${endpoint.name} (${endpoint.url}) - Status: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`‚ùå ${endpoint.name} (${endpoint.url}) - Error: ${error.message}`, 'error');
            }
        }
        
        if (laravelWorking) {
            updateStatus('‚úÖ Laravel server working', 'success');
        } else {
            updateStatus('‚ùå Laravel server issues', 'error');
            log('üí° Possible solutions:', 'info');
            log('   1. Run: php artisan serve', 'info');
            log('   2. Check Laragon/XAMPP is running', 'info');
            log('   3. Verify project is in correct directory', 'info');
        }
        
        return laravelWorking;
    }

    async function testRoutes() {
        updateStatus('Testing routes...', 'info');
        log('üîç Testing specific Laravel routes...', 'info');
        
        const routes = [
            { url: '/pengurus/barang', method: 'GET', name: 'Barang Index' },
            { url: '/pengurus/barang/create', method: 'GET', name: 'Barang Create' },
            { url: '/pengurus/kategori', method: 'GET', name: 'Kategori Index' }
        ];
        
        let routesWorking = 0;
        
        for (const route of routes) {
            try {
                const response = await fetch(route.url, {
                    method: route.method,
                    headers: { 'Accept': 'text/html' }
                });
                
                if (response.ok) {
                    log(`‚úÖ ${route.name} (${route.url}) - OK`, 'success');
                    routesWorking++;
                } else if (response.status === 302) {
                    log(`üîÑ ${route.name} (${route.url}) - Redirect (auth required)`, 'warning');
                    routesWorking++;
                } else if (response.status === 404) {
                    log(`‚ùå ${route.name} (${route.url}) - Route not found`, 'error');
                } else {
                    log(`‚ö†Ô∏è ${route.name} (${route.url}) - Status: ${response.status}`, 'warning');
                }
            } catch (error) {
                log(`‚ùå ${route.name} (${route.url}) - Network error: ${error.message}`, 'error');
            }
        }
        
        if (routesWorking > 0) {
            updateChecklist('routes', true);
            updateStatus(`‚úÖ ${routesWorking}/${routes.length} routes working`, 'success');
        } else {
            updateChecklist('routes', false);
            updateStatus('‚ùå No routes working', 'error');
        }
        
        return routesWorking > 0;
    }

    function testComponents() {
        updateStatus('Testing components...', 'info');
        log('üîç Testing required components...', 'info');
        
        // Test CSRF Token
        const csrfToken = document.querySelector('meta[name="csrf-token"]');
        if (csrfToken && csrfToken.getAttribute('content')) {
            log('‚úÖ CSRF Token found in meta tag', 'success');
            updateChecklist('csrf', true);
        } else {
            log('‚ùå CSRF Token not found in meta tag', 'error');
            updateChecklist('csrf', false);
        }
        
        // Test Font Awesome
        const faTest = document.createElement('i');
        faTest.className = 'fas fa-test';
        faTest.style.display = 'none';
        document.body.appendChild(faTest);
        
        const faStyles = window.getComputedStyle(faTest);
        if (faStyles.fontFamily && faStyles.fontFamily.includes('Font Awesome')) {
            log('‚úÖ Font Awesome loaded successfully', 'success');
            updateChecklist('fontawesome', true);
        } else {
            log('‚ùå Font Awesome not loaded properly', 'error');
            updateChecklist('fontawesome', false);
        }
        document.body.removeChild(faTest);
        
        // Test Tailwind CSS
        const tailwindTest = document.createElement('div');
        tailwindTest.className = 'bg-blue-500 text-white p-4';
        tailwindTest.style.display = 'none';
        document.body.appendChild(tailwindTest);
        
        const tailwindStyles = window.getComputedStyle(tailwindTest);
        if (tailwindStyles.backgroundColor === 'rgb(59, 130, 246)' || tailwindStyles.backgroundColor.includes('blue')) {
            log('‚úÖ Tailwind CSS loaded successfully', 'success');
            updateChecklist('tailwind', true);
        } else {
            log('‚ùå Tailwind CSS not loaded properly', 'error');
            updateChecklist('tailwind', false);
        }
        document.body.removeChild(tailwindTest);
        
        updateStatus('Component testing completed', 'info');
    }

    async function testCRUD() {
        updateStatus('Testing CRUD operations...', 'info');
        log('üîç Testing CRUD operations...', 'info');
        
        // Test GET requests first
        try {
            const getResponse = await fetch('/pengurus/barang', {
                method: 'GET',
                headers: { 'Accept': 'application/json' }
            });
            
            if (getResponse.ok) {
                log('‚úÖ GET /pengurus/barang - Success', 'success');
            } else if (getResponse.status === 302) {
                log('üîÑ GET /pengurus/barang - Redirect (need login)', 'warning');
                log('üí° Please login first at /login', 'info');
            } else {
                log(`‚ùå GET /pengurus/barang - Status: ${getResponse.status}`, 'error');
            }
        } catch (error) {
            log(`‚ùå GET /pengurus/barang - Network error: ${error.message}`, 'error');
            
            if (error.message.includes('Failed to fetch')) {
                log('üí° "Failed to fetch" usually means:', 'info');
                log('   1. Server is not running (php artisan serve)', 'info');
                log('   2. Wrong URL or port', 'info');
                log('   3. CORS issues', 'info');
                log('   4. Firewall blocking connection', 'info');
            }
        }
        
        // Test POST request (will likely fail without auth, but we can see the error)
        try {
            const formData = new FormData();
            formData.append('nama', 'Test Category');
            
            const postResponse = await fetch('/pengurus/kategori', {
                method: 'POST',
                body: formData,
                headers: {
                    'Accept': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            
            if (postResponse.ok) {
                log('‚úÖ POST /pengurus/kategori - Success', 'success');
            } else if (postResponse.status === 302) {
                log('üîÑ POST /pengurus/kategori - Redirect (need login)', 'warning');
            } else if (postResponse.status === 422) {
                log('‚ö†Ô∏è POST /pengurus/kategori - Validation error (expected)', 'warning');
            } else {
                log(`‚ùå POST /pengurus/kategori - Status: ${postResponse.status}`, 'error');
            }
        } catch (error) {
            log(`‚ùå POST /pengurus/kategori - Network error: ${error.message}`, 'error');
        }
        
        updateStatus('CRUD testing completed', 'info');
    }

    // Auto-run tests when page loads
    document.addEventListener('DOMContentLoaded', function() {
        log('üöÄ Page loaded, starting automatic tests...', 'info');
        
        setTimeout(async () => {
            testComponents();
            
            setTimeout(async () => {
                const basicOk = await testBasicConnection();
                if (basicOk) {
                    setTimeout(async () => {
                        await testLaravelServer();
                        setTimeout(testRoutes, 1000);
                    }, 1000);
                }
            }, 500);
        }, 500);
    });
    </script>
</body>
</html>